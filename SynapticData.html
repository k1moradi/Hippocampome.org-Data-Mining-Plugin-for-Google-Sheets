<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('script_CSS'); ?>
    <style>
      p > br {
        content: '';
        white-space: pre;
      }
      <?for (var i = 1; i <= 1000; i++) {?>
        p > br:nth-child(<?=i?>):after {content: '\A      ';}
      <?}?>
    </style>
  </head>
  <body>
    <iframe style="float:left; width:662px; height:729px;" src="<?=url?>" scrolling="yes" marginwidth="0" marginheight="0" frameborder="0" vspace="0" hspace="0"></iframe>
    <div id='main' style='float:right; width:786px; height:729px; overflow:auto;'>
    
      <?//-----Functions----------------------------------------------------------------------------------------------------------------
        function showReferences(linkedRefIDs,allReferences,references,groupName,bgColor,fontColor,fontSize) {
          if (linkedRefIDs.length !== 0) { ?>
      <details open>
        <summary style='background-color:<?=bgColor?>;color:<?=fontColor?>; margin:0; font-size:<?=fontSize?>;'>
          <?= groupName ?>
        </summary>
        <? linkedRefIDs.sort(function(a,b){return a-b}).forEach(function(refID){
            var theReference = references[refID]; ?>
        <details id='Reference' open>
          <summary style='background-color:black; color:white; margin:0; font-size:120%;'>
            <b>ID:</b><a style='color:pink' href='javascript:return false;' onclick="copyStringToClipboard('@'+this.text)"><?= refID ?></a>, 
            <? if (typeof theReference !== "undefined") {?>
            <i style='color:yellow'><?= theReference.Location?></i>, 
            <?=theReference.UID}?>
          </summary>
          <?if (typeof theReference === "undefined") {?>
          <p style='color:red;'>
            ❌ ID is not associated with any reference in our database. Delete it!
          </p>
          </details>
          <?} else {
              var UID = theReference.UID;
              if (UID) {?>
          <details>
            <summary style='background-color:#3F51B5; color:white; margin:0;'>
              <b>Cell Types:</b>
            </summary>
            <?  if (typeof UID === 'string') {
                  if (UID.replace(/[\s\d,;]+/g,'') !== '') {// is not a UID array in string format
                    UID.split(/\s*[,;]+\s*/g)
                       .filter(Null)
                       .forEach(function(eachUID){ ?>
            <p><?=       eachUID ?>
            </p><?     });
                  } else {
                    UID.split(/\s*[,;]+\s*/g)
                        .filter(Null)
                        .forEach(function(eachUID){?>
            <p><b><?=      eachUID ?>: </b><?=(cellTypes[eachUID]) ? cellTypes[eachUID].Name : '❌undefined cell type UID';?>
            </p>
            <?          }); 
                  };
                } else { ?>
            <p><b><?= UID ?>: </b><?= (cellTypes[UID]) ? cellTypes[UID].Name : UID+':❌undefined cell type UID'; ?>
            </p>
            <?  } ?>
          </details>
          <?  }?>
          <p>
            <?!= refHighlights(theReference.Quote) ?>
          </p>
          <?if (theReference.Figure) {
              String(theReference.Figure)
              .split(/\s*[;,]+\s*/g)
              .filter(Null)
              .forEach(function(fileName){
                var fileIDs = getFileIDs(fileName);
                if (fileIDs.length !== 0) {
                  fileIDs.forEach(function(fileID){
                    if (fileName.replace(/\.[^.]*$/g,'') === refID || (theReference.HcoRefID && imagesShown.indexOf(fileName) === -1)) {
                      imagesShown.push(fileName);?>
          <details open>
          <?        } else {?>
          <details>
          <?        }?>
            <summary style='background-color:#3F51B5; color:white; margin:0;'>
              <b>File: </b><a style='color:white' href='javascript:return false;' onclick="copyStringToClipboard(this.text)"><?=fileName?></a>
              <?    var possibleRefID = fileName.replace(/\.[^.]*$/g,'');
                    if (possibleRefID.replace(/\d*/g,'') === '') { 
                      var theFigRef = allReferences[possibleRefID]; 
                      if (theFigRef) {?>
              <?=       theFigRef.Location?>
              <?      }};?>
            </summary>
            <img src='https://drive.google.com/uc?export=view&id=<?=fileID?>' style='width:100%;'>
            <?      if (theFigRef && (fileName.replace(/\.[^.]*$/g,'') !== refID)) {?>
            <p><?!=   (theFigRef.Location !== theReference.Location) ? refHighlights(theFigRef.Quote) : ''; ?>
              <?      theFigRef=null};?>
            </p>
          </details>
          <?      })} else {?>
          <p style='background-color:#3F51B5; color:white; margin:0;'>❌<b>File:</b> <?=String(fileName)?> does not exist</p>
          <?  }})};?>
        </details>
        <?}})?>
      </details>
      <? }};
      
        function showAllReferences(presynapticRefIDs,postsynapticRefIDs,allReferences,groupReferences,groupName,bgColor,fontColor) {?>
      <details open>
        <summary style='background-color:<?=bgColor?>;color:<?=fontColor?>; margin:0; font-size:200%;'>
          <?=groupName?>
        </summary>
        <? var refIDsUniqueToPre  = presynapticRefIDs.filter(function(refID){return (postsynapticRefIDs.indexOf(refID) === -1)}); 
           var refIDsUniqueToPost = postsynapticRefIDs.filter(function(refID){return (presynapticRefIDs.indexOf(refID) === -1)}); 
           var refIDsCommonToBoth = presynapticRefIDs.filter(function(refID){return (refIDsUniqueToPre.indexOf(refID) === -1)});
           var linkedRefIds = mergeArrays(presynapticRefIDs,postsynapticRefIDs);
           var unlinkedRefIds = Object.keys(groupReferences).filter(function(refID){return (linkedRefIds.indexOf(refID) === -1)});
           showReferences(refIDsCommonToBoth,allReferences  ,allReferences,'✅Both Sides'       ,'#3F51B5','white','150%'); 
           showReferences(refIDsUniqueToPre ,allReferences  ,allReferences,'✅Presynaptic Only' ,'#3F51B5','white','150%'); 
           showReferences(refIDsUniqueToPost,allReferences  ,allReferences,'✅Postsynaptic Only','#3F51B5','white','150%'); 
           showReferences(unlinkedRefIds    ,allReferences,groupReferences,'❌Unlinked'         ,'#3F51B5','white','150%'); ?>
      </details>
      <?}; 
      
//============================================top=======================================================================================

        //-----We have access to these objects: evidence cellTypes covariates oldSynData synRefs covRefs myRefs-------------------------?>
      <div style='width:100%; height:25px; position:fixed;'>
        <input type='text' placeholder='Case-sensitive Search and Highlight in Green' style='width:640px;' onchange="caseSensitiveSearch(this.value,'main');">
        <input type='button' value='References:Collapse' onclick='toggleReferences(this)'>
      </div>
      <div id='evidence' style='margin-top:25px'>
      <a href='https://www-ncbi-nlm-nih-gov.mutex.gmu.edu/pubmed/?term=<?=evidence.PMID?>' target='_blank'><?=covariates.Reference?></a><br>
      
      <?//-----What we know about the evidence -----------------------------------------------------------------------------------------?>
        
      <details>
        <summary style='background-color:#4285F4;color:white; font-size:200%;'>
          Evidence Details
        </summary>
        <? ['DataLocation','dSec','Description','Assumptions','ConRatios','CellRatios','Notes','RMPorVh','ErevAuthors',
        'ErevCalculated','Drugs','ExtracellularSolution','IntracellularSolution']
        .forEach(function(key){ 
           if (evidence[key].length != 0) {?>
             <p><b>
               <?=key?>: </b><?!= evidence[key] ?>
             </p>
        <?}});?>
      </details>
      
      <?//-----Covariates Extracted so far---------------------------------------------------------------------------------------------?>
        
      <details>
        <summary style='background-color:rgb(153, 255, 255);color:black; margin:0; font-size:200%;'>
          Covariates Extracted
        </summary>
        <? Object.keys(covariates)
             .filter(function(key){return (key!=='Order Added' && key!=='PMID' && key!=='Reference' && key!=='Order Added' && 
                                           key!=='Not Mined Not Vetted' && key!=='K1 vetted Ephys parameterd reported' && 
                                           key!=='Temperature'  && key!=='Glucose'  && key!=='Intracellular_pH'  && key!=='IntracellularPipetteSolution' &&
                                           key!=='ExtracellularBathSolution' && key!=='DataExtracted' && key!=='Stain')})
             .forEach(function(key){ 
               if (covariates[key].length != 0 && covariates[key] !='-') {?>
            <p>
            <b><?=key?>: </b><?= covariates[key] ?></p>
        <? }});?>
      </details>
      
      <?//-----Covariates References---------------------------------------------------------------------------------------------------?>

      <? showReferences(evidence.CovariatesIDs  ,allRefs, allRefs,'Covariates References','#99FFFF','black','200%');  
         showAllReferences(evidence.CellePhysIDsPre, evidence.CellePhysIDsPost, allRefs, cellEphys,'Electrophysiology:','#0090CC','yellow');?>
        
      <?//-----Synaptic Data References-------------------------------------------------------------------------------------------------?>

      <? showReferences(evidence.DataIDs,allRefs, allRefs,'Synaptic Data','#E91E63','white','200%'); ?>

      <?//-----Synaptic Data extracted by Interns---------------------------------------------------------------------------------------?>

      <details open>
        <summary style='background-color:rgb(233, 30, 99);color:white; margin:0; font-size:200%;'>
          Synaptic Data Extracted by Summer Interns
        </summary>
          <? Object.keys(oldSynData).forEach(
               function(key){ ?>
        <h3 style='background-color:black;color:white; margin:0;'>
          <?=     key?>: 
        </h3>
        <?Object.keys(oldSynData[key])
           .forEach(
             function(key2){ 
               if (oldSynData[key][key2].length != 0) { ?>
        <p>
           <b><?=key2?>: </b>
           <?= oldSynData[key][key2] ?>
        </p>
        <? }})}); ?>
      </details>
    </div>
    </div>
  </body>
</html>