<?//-----Functions----------------------------------------------------------------------------------------------------------------
//get a sheet sampling object and make an editable form
// this object has rowRange and columnName2Number keys
function showObject(obj,title,top,zIndex,defaultSelection,filterKey) {
  var columnName2Number = obj.columnName2Number;
  filterKey.push('columnName2Number','rowRange')?>
<form class="sheet" style="top:<?=top?>;z-index:<?=zIndex?>">
  <select onchange="showValue(this,'<?='showObject'+title?>')" data-range="<?=obj.rowRange?>">
    <? Object.keys(obj).forEach(function(key){if (filterKey.indexOf(key) === -1){?>
      <option value="<?=key?>" data-content="<?=obj[key]?>" data-column="<?=columnName2Number[key]?>"
        <?if (key === defaultSelection){?>selected<?}?>><?=key?></option>
      <? }}); ?>
  </select>
  <textarea id="<?='showObject'+title?>" class="editor" onblur="saveValue(this);" 
    onmouseenter="((e)=>{e.style.height=(e.scrollHeight > e.clientHeight)?(e.scrollHeight)+'px':e.parentElement.style.height+'px'})(this);" 
    onmouseleave="this.style.height = '25px';"><?=obj[defaultSelection]?></textarea>
</form>
<?};

  function showReferences(linkedRefIDs,allReferences,references,groupName,bgColor,fontColor,fontSize,stringToAppendToRefIDs) {
    if (linkedRefIDs.length !== 0) { ?>
<div class="eachReference">    
<details open>
  <summary style="background-color:<?=bgColor?>;color:<?=fontColor?>; margin:0; font-size:<?=fontSize?>;">
    <?= groupName ?>
  </summary>
  <? linkedRefIDs.sort(function(a,b){return a-b}).forEach(function(refID){
      var theReference = references[refID]; ?>
  <details id="<?=(theReference)?theReference.rowRange:''?>" class="Refs" ontoggle="toggleSticky(this)" close>
    <summary class="navBar"
      ><span class="disableClick darkButton" onclick="saveReference(this)">üíæ</span
      ><span
        ><span class="disableClick darkButton" onclick="copyStringToClipboard(<?=stringToAppendToRefIDs?>+this.innerText)" style="color:pink"><?=refID?></span
        ><? if (typeof theReference !== "undefined") {
              var UID = theReference.UID;?>
        <span class="disableClick darkButton" onclick="copyStringToClipboard(this.innerText)" style="color:yellow"><?=theReference.Location?></span></span
      ><span contenteditable="true" class="UID disableClick"
      ><?=(isNumeric(UID)) ? ((cellTypes[UID]) ? cellTypes[UID].Name : '‚ùåundefined cell type UID') : UID ?></span>
       <?   }?>
    </summary>
    <?if (typeof theReference === "undefined") {?>
    <p style='color:red;'>
      ‚ùå ID is not associated with any reference in our database. Delete it!
    </p>
    </details>
    <?} else {
        var UID = theReference.UID;
        if (UID) {?>
    <!--<details>
      <summary style='background-color:#3F51B5; color:white; margin:0;'>
        <b>Cell Types:</b>
      </summary>
      <?  if (typeof UID === 'string') {
            if (UID.replace(/[\s\d,;]+/g,'') !== '') {// is not a UID array in string format
              UID.split(/\s*[,;]+\s*/g)
                 .filter(Null)
                 .forEach(function(eachUID){ ?>
      <p><?=       eachUID ?>
      </p><?     });
            } else {
              UID.split(/\s*[,;]+\s*/g)
                  .filter(Null)
                  .forEach(function(eachUID){?>
      <p><b><?=      eachUID ?>: </b><?=(cellTypes[eachUID]) ? cellTypes[eachUID].Name : '‚ùåundefined cell type UID';?>
      </p>
      <?          }); 
            };
          } else { ?>
      <p><b><?= UID ?>: </b><?= (cellTypes[UID]) ? cellTypes[UID].Name : UID+':‚ùåundefined cell type UID'; ?>
      </p>
      <?  } ?>
    </details>-->
    <?  }?>
    <div class='Quote' contenteditable='true'><p>
      <?!= refHighlights(theReference.Quote) ?>
    </p></div>
    <?if (theReference.Figure) {
        String(theReference.Figure)
        .split(/\s*[;,]+\s*/g)
        .filter(Null)
        .forEach(function(fileName){
          var fileIDs = getFileIDs(fileName);
          if (fileIDs.length !== 0) {
            fileIDs.forEach(function(fileID){
              if (fileName.replace(/\.[^.]*$/g,'') === refID || (theReference.HcoRefID && imagesShown.indexOf(fileName) === -1)) {
                imagesShown.push(fileName);?>
    <details class='Figs' open>
    <?        } else {?>
    <details class='Figs'>
    <?        }?>
      <summary style='background-color:#3F51B5; color:white; margin:0;'>
        <b>File: </b><a style='color:white' href='javascript:void(0)' onclick="copyStringToClipboard(this.text)"><?=fileName?></a>:
        <?    var possibleRefID = fileName.replace(/\.[^.]*$/g,'');
              if (possibleRefID.replace(/\d*/g,'') === '') {
                var theFigRef = allReferences[possibleRefID]; 
                if (theFigRef) {?>
        <?=       theFigRef.Location?>
        <?      }};?>
      </summary>
      <img src='https://drive.google.com/uc?export=view&id=<?=fileID?>' style='width:100%;'>
      <?      if (theFigRef && (fileName.replace(/\.[^.]*$/g,'') !== refID)) {?>
      <p><?!=   (theFigRef.Location !== theReference.Location) ? refHighlights(theFigRef.Quote) : ''; ?>
        <?      theFigRef=null};?>
      </p>
    </details>
    <?      })} else {?>
    <p style='background-color:#3F51B5; color:white; margin:0;'>‚ùå<b>File:</b> <?=String(fileName)?> does not exist</p>
    <?  }})};?>
  </details>
  <?}})?>
</details>
</div>
<? }};
         
  function showAllReferences(presynapticRefIDs,postsynapticRefIDs,allReferences,groupReferences,groupName,bgColor,fontColor,stringToAppendToRefIDs) {?>
<details open>
  <summary style='background-color:<?=bgColor?>;color:<?=fontColor?>; margin:0; font-size:200%;'>
    <?=groupName?>
  </summary>
  <? var refIDsUniqueToPre  = presynapticRefIDs.filter(function(refID){return (postsynapticRefIDs.indexOf(refID) === -1)});
     var refIDsUniqueToPost = postsynapticRefIDs.filter(function(refID){return (presynapticRefIDs.indexOf(refID) === -1)});
     var refIDsCommonToBoth = presynapticRefIDs.filter(function(refID){return (refIDsUniqueToPre.indexOf(refID) === -1)});
     var linkedRefIds = mergeArrays(presynapticRefIDs,postsynapticRefIDs);
     var unlinkedRefIds = Object.keys(groupReferences).filter(function(refID){return (linkedRefIds.indexOf(refID) === -1)});
     showReferences(refIDsCommonToBoth,allReferences  ,allReferences,'‚úÖBoth Sides'       ,'#3F51B5','white','150%',stringToAppendToRefIDs);
     showReferences(refIDsUniqueToPre ,allReferences  ,allReferences,'‚úÖPresynaptic Only' ,'#3F51B5','white','150%',stringToAppendToRefIDs);
     showReferences(refIDsUniqueToPost,allReferences  ,allReferences,'‚úÖPostsynaptic Only','#3F51B5','white','150%',stringToAppendToRefIDs);
     showReferences(unlinkedRefIds    ,allReferences,groupReferences,'‚ùåUnlinked'         ,'#3F51B5','white','150%',stringToAppendToRefIDs); ?>
</details>
<?}; ?>
<?!=include('shortcuts');?>    
<script>
  shortcut.add('Ctrl+.'  ,function(){document.execCommand('superscript', false, null)});
  shortcut.add('Ctrl+,'  ,function(){document.execCommand('subscript', false, null)});
  shortcut.add('Ctrl+m'  ,function(){document.execCommand('insertText', false, '¬µ')});
  shortcut.add('Ctrl+f12',function(){document.execCommand('insertText', false, '‚Äì')});
  shortcut.add('enter',function(){document.execCommand('insertHTML', false, '<br><br>')});
  shortcut.add('f2'      ,function(){saveReference(document.activeElement)});
  <?!=refHighlights.toString();?>
  
  window.onload = function() {
    Array.from(document.querySelectorAll('.disableClick')).forEach(
      function(elem){
        //disable click on focus to element
        elem.addEventListener('click',function(e) {
          e.preventDefault();
        });
        //disable click on keyup
        elem.addEventListener('keyup',function(e) {
          e.preventDefault();
        });
    });
    
    Array.from(document.querySelectorAll('.Refs')).forEach(
      function(elem){
        elem.addEventListener('copy', function(e) {
          showSnackbar('üìã '+ ((txt = e.clipboardData.getData('text/plain'))? txt : document.getSelection().toString()));
        });
//        elem.addEventListener('focus', function(){
//          document.activeElement.closest('.navBar').classList.add('sticky')
//        }, true);
//        elem.addEventListener('blur', function(){
//          document.activeElement.closest('.navBar').classList.remove('sticky')
//        }, true);
    });
    Array.from(document.querySelectorAll('.UID')).forEach(
      function(elem){
        elem.addEventListener("paste", 
          function(e) {
            // cancel paste
            e.preventDefault();
            // get text representation of clipboard
            //var text = e.clipboardData.getData("text/plain"); 
            var divElem = document.createElement('div');
            divElem.innerHTML = e.clipboardData.getData('text/html');
            //convert small-capps to real capital letters
            while (smallCapElem = divElem.querySelector('.sc')) 
              smallCapElem.outerHTML = smallCapElem.innerText.toUpperCase();
            document.execCommand("insertHTML", false, divElem.innerText.replace(/^[\s\n\r]+|[\s\n\r]+$/g,''));
          });
      });
  };
  function toggleReferences(button) {
    var detailSummaryElems = Array.from(document.querySelectorAll('.'+button.id))
    if (button.value === button.id+'.‚ñ∂') {
      button.value =     button.id+'.‚ñº';
      detailSummaryElems.forEach(function(elem) {elem.open = true});
    } else {
      button.value =     button.id+'.‚ñ∂';
      detailSummaryElems.forEach(function(elem) {elem.open = false});
    }
  }
  function toggleSticky(elem) {
    if(elem.open) 
      elem.getElementsByClassName('navBar')[0].classList.add('sticky')
    else 
      elem.getElementsByClassName('navBar')[0].classList.remove('sticky')
  };//==========================================================================================================================
  function caseSensitiveSearch(text,id) {
    while (span = document.querySelector('.labnol')) 
      span.outerHTML = String(span.outerHTML).replace(/<span.*?class="labnol".*?>(.*?)<\/span>/g,"$1");
    if (text == null || text.length == 0) return;
    function searchWithinNode(node, te, len) {
      var pos, skip, spannode, middlebit, endbit, middleclone;
      skip = 0;
      if (node.nodeType == 3) {
        pos = node.data.indexOf(te);
        if (pos >= 0) {
          spannode = document.createElement('span');
          spannode.setAttribute('class', 'labnol');
          spannode.style.backgroundColor = 'rgb(140, 255, 26 )';
          middlebit = node.splitText(pos);
          endbit = middlebit.splitText(len);
          middleclone = middlebit.cloneNode(true);
          spannode.appendChild(middleclone);
          middlebit.parentNode.replaceChild(spannode, middlebit);
          skip = 1
        }
      } else if (node.nodeType == 1 && node.childNodes && node.tagName.toUpperCase() != 'SCRIPT' && node.tagName.toUpperCase != 'STYLE') {
        for (var child = 0; child < node.childNodes.length; ++child) {
          child = child + searchWithinNode(node.childNodes[child], te, len)
        }
      }
      return skip
    }
    text.split(/\s*\|+\s*|\s+/g
    ).filter(function(txt) {
      return txt
    }).sort(function(a, b) {
      return b.length - a.length
    }).forEach(function(txt) {
      searchWithinNode(document.getElementById(id), txt, txt.length)
    })
  };
  
  function copyStringToClipboard(string) {
    function handler(event){
        event.clipboardData.setData('text/plain', string);
        event.preventDefault();
        document.removeEventListener('copy', handler, true);
    }
    document.addEventListener('copy', handler, true);
    document.execCommand('copy');
  }
  function saveReference(activeElement){
    var Error = false;
    try {
      var detailsSummaryElem = activeElement.closest('.Refs');
      if (detailsSummaryElem) if (detailsSummaryElem.nodeName === 'DETAILS' && detailsSummaryElem.className === 'Refs'){
        var A1Notation = detailsSummaryElem.id;
        var UIDelemValue = detailsSummaryElem.querySelector('.UID').innerText
        //var UIDelemValue = detailsSummaryElem.querySelector('.UID').value
          .replace(/\s*(?:%3E|&gt;|>|‚ñ∂)\s*/g,'‚ñ∂')
          .replace(/\s*(?:%3C|&lt;|<|‚óÄ)\s*/g,'‚óÄ')
          .replace(/\s*(?:\*|‚ùå)\s*/g,'‚ùå')
          .replace(/\s+/g,' ');
        var Quote = detailsSummaryElem.querySelector('.Quote');
        //remove highlights
        while (mark = Quote.querySelector('mark')) 
          mark.outerHTML = mark.innerHTML;
        //remove case-sensitive search tool highlights
        while (span = Quote.querySelector('span')) 
          span.outerHTML = span.innerHTML;
        //convert <div> to <br>
        while (div = Quote.querySelector('div')) 
          div.outerHTML = div.innerHTML+'<br>';
        //convert <p> to <br>
        while (p = Quote.querySelector('p')) 
          p.outerHTML = p.innerHTML+'<br>';
    
        var quoteValue = Quote.innerHTML
          .replace(/(?:&nbsp;|[\s\r\n\x0A])+/g,' ')
          .replace(/^(?:<br>|&nbsp;|[\s\r\n\x0A])+|(?:<b>(?:&nbsp;|[\s\r\n\x0A])*<\/b>)+|(\d+)\s*(¬±)\s*(\d+)|(?:<br>|&nbsp;|[\s\r\n\x0A])+$/g,'$1$2$3')
          .replace(/(?:(?:\s|<[bi]>)*<br>(?:\s|<[bi]>)*){2,}/g,'<br>')
//          .replace(/&lt;/g,'<')
//          .replace(/&gt;/g,'>')
          .replace(/&ndash;/g,'‚Äî')
          .replace(/&amp;/g,'&');
      
        var quoteValueHighlighted = refHighlights(quoteValue);
      
        Error = Array.from(document.querySelectorAll('.Refs')).filter(
          function(element) {
            //alert(element.id+' : '+A1Notation)
            if (element.id === A1Notation) {
              element.querySelector('.UID').innerText = UIDelemValue;
              //element.querySelector('.UID').value = UIDelemValue;
              element.querySelector('.Quote').innerHTML = '<p>'+quoteValueHighlighted+'</p>';
              return true; //means no error
            } else {
              return false;
            }
          }).length === 0;
        } else {
          Error = true;
        }
    } catch(error) {
      Error = true;
    }
    
    if (!Error) {google.script.run
      .withFailureHandler(showSnackbar("<b style='color:lightsalmon'>failed to save</b>"))
      .withSuccessHandler(showSnackbar('saved successfully'))
      .saveReferenceToSheet(A1Notation,UIDelemValue.replace(/^[\s,;]*|[\s,;]*$/g,''),quoteValue);
      caseSensitiveSearch(document.getElementById('csSearch').value,'main');
    } else {
      showSnackbar("<b style='color:lightgoldenrodyellow'>failed to save</b>");
    }
  };
  function showValue(elem,ID){
    var selecteOptionElem = elem.options[elem.selectedIndex];
    document.getElementById(ID).value=selecteOptionElem.dataset.content;
  }
  function saveValue(elem){
    var selectElem = elem.parentElement.getElementsByTagName('select')[0];
    var selectedOptionElem = selectElem.options[selectElem.selectedIndex];
    selectedOptionElem.dataset.content=elem.value;
    google.script.run
      .withFailureHandler(function(){showSnackbar("<b style='color:lightgoldenrodyellow'>failed to save</b>")})
      .withSuccessHandler(function(){showSnackbar('saved successfully')})
      .saveToSheetGeneral(selectElem.dataset.range, Number(selectedOptionElem.dataset.column)+1, elem.value)
  }
</script>
<style>
body {
  margin: 0px;
  background-color:white;
}
:root { 
  --googleFormWidth: <?= (displayForm)? '50vw' : '0vw' ?>;
}
.googleForm {
  float:left; 
  width: var(--googleFormWidth);
  height: 100vh;
}
.referencePanel {
  float:right; 
  overflow:auto;
  --referencePanelWidth: calc(100vw - var(--googleFormWidth));
  width: var(--referencePanelWidth);
  height: 100vh;
}
.eachReference {
  width:100%;
  word-wrap:normal;
  z-index:0;
}
.Refs {
  font-family: Verdana, Arial, Helvetica, sans-serif;/*'Open Sans', sans-serif;*/
  font-size: 16px;
}
.Refs summary {
  background-color:black; 
  color:white; 
  margin:0; 
  font-size:100%; 
  display:flex; 
  flex-direction:row;
  vertical-align: middle;
}
.Refs br {
  line-height:200%;
}
.Refs sup {
  font-size: 55%;
  font-weight: bold;
  vertical-align: 50%;
}
.UID {
  flex:1; 
  /*padding-top:2px;*/
  border: 1px solid black;
}
.sticky {
  position: -webkit-sticky;  /* Safari */
  position: sticky;
  top: 45px;
  z-index:1;
}
.sheet{
  display:flex;
  /* flex-direction:row; */
  position: -webkit-sticky;
  position: sticky;
  /* top: 25px; */
  background-color:white;
  width:100%;
  height:25px;
  /* z-index: 2;*/
}
.sheet > select {
  width:147px;
  background-color:black;
  color:white;
}
.editor{
  flex:1;
  min-width:50%;
  background-color:white;
  height:25px;
  resize:none;
  font-family: Verdana, Arial, Helvetica, sans-serif;/*'Open Sans', sans-serif;*/
  font-size: 16px;
}
.editor:hover{
  height:fit-content;
}
</style>