<!DOCTYPE html>
<html>
 <head>
 <base target="_top">
   <style>
     table {
       border-collapse: collapse;
     }
     table, th, td {
       border: 1px solid black;
       text-align: left;
       padding: 5px;
     }
     tr:hover{background-color:#f5f5f5}
     th {
       background-color: #4CAF50;
       color: white;
     }

     .text {
       width: 95vw;
       height: calc(20vh - 26px); //775px; //615px
       padding: 0px;
       font: 12px/18px 'Open Sans', sans-serif;
       letter-spacing: 1px;
       line-height: 1.5em;
     }
     div[contenteditable]:focus {
       border: 1px solid rgb(86, 180, 239);
       box-shadow: 0px 1px 3px rgba(0, 0, 0, 0.05) inset, 0px 0px 8px rgba(82, 168, 236, 0.6);
     }

     div[contenteditable] {
       //width: 97vw;
       max-width: 97vw;
       min-height: 30px;
       overflow: hidden;
       margin-right: 10px;
       
       font-family: Arial,sans-serif;
       
       -webkit-box-shadow: inset 0 1px 3px rgba(0,0,0,.05),0 1px 0 rgba(255,255,255,.075);
       box-shadow: inset 0 1px 3px rgba(0,0,0,.05),0 1px 0 rgba(255,255,255,.075);
       
       display: inline-block;
       padding: 4px;
       margin: 0;
       outline: 0;
       background-color: #fff;
       border: 1px solid #ccc;
       border-radius: 3px;
       
       font-size: 13px;
       line-height: 20px;
     }
    mark{
      background: white;
      color: black;
      font-weight: bold;
    }
    
   </style>
   <?!= include("sorttable") ?>
   <?!= include("rangy-selectionsaverestore") ?>
   <?!= include("balanced") ?>
 </head>
 <body>
   <div contenteditable='true' id='editor' class=text><?!= evidence.Query ?>
   </div>
     <input type="button" value="search" onclick="reCheckQuery(document.getElementById('editor').innerText)">
   <br>
   <div id='error'><b>Error:</b><?!=(error)?error:''?></div>
   <script>
     var errorElem = document.getElementById("error");
     function queryHighlighter(string){
       //prompt('',string)
       try {
         errorElem.innerHTML = '<b>Error:</b>';
         balanced.matches({
           source: string, 
           open: '(', 
           close: ')', 
           balance: true, 
           exceptions: true});
       } catch (error) {
         //prompt('',JSON.stringify(error)) {"line":1,"column":396,"index":395}
         errorElem.innerHTML = "<b style='color:red'>Error:</b> imbalanced parentheses"/*+
                               "<br>"+error.index+":"+error.column
                               "<br>line:"+error.line+
                               "<br>column:"+error.column*/;
       };
       return balanced.replacements({
        source: string
          //.replace(/(Presynaptic|Postsynaptic|\)(?:<span.*id=.*selectionBoundary.*>﻿<\/span>|\s)*$)/ig,"<br>$1")
          .replace(/(\b(?:Connection|Presynaptic|Postsynaptic|Neurotransmitter|Morphology|Markers|Electrophysiology|FiringPattern|Exclude|Include|Name)\b(?:<span.*id=.*selectionBoundary.*>﻿<\/span>)?:)/ig,"<b>$1</b>")
          .replace(/((?:Axons|Dendrites|Soma|[di][+\-])(?:<s.+﻿.+n>)?:|(?:Excita|Inhibi)tory|both)/ig,"<b style='color:navy'><i>$1</i></b>")
          .replace(/(\b(?:CA[1-3]|DG|EC|SUB)\b(?:<span.*id=.*selectionBoundary.*>﻿<\/span>)?:)/g,"<b style='color:darkred'>$1</b>")
          .replace(/(\b(?:AND|OR|NOT)\b)/g,"<b style='color:purple'>$1</b>"),
        head:/\(/,
        open: '(',
        close: ')',
        balance: true, 
        replace: function (source, head, tail) {
          return '<b>' + head + '</b>' + source + '<b>' + tail + '</b>';
        }
      });  
     };
     
     var savedSel = null;
     var savedSelActiveElement = document.getElementById("editor");
     
     window.onload = function() {
       // Turn multiple selections on in IE
       try {
         document.execCommand("MultipleSelection", null, true);
       } catch(ex) {}

       rangy.init();
       var saveRestoreModule = rangy.modules.SaveRestore;
       //if (rangy.supported && saveRestoreModule && saveRestoreModule.supported) {}
       savedSelActiveElement = document.getElementById("editor");
       savedSelActiveElement.innerHTML = queryHighlighter(savedSelActiveElement.innerText)
     };

     function saveSelection() {
       if (savedSel) rangy.removeMarkers(savedSel);
       savedSel = rangy.saveSelection();
     }
     function restoreSelection() {
       if (savedSel) {
         rangy.restoreSelection(savedSel, true);
         savedSel = null;
         window.setTimeout(function() {
           if (savedSelActiveElement && typeof savedSelActiveElement.focus != "undefined") {
             savedSelActiveElement.focus();
           }
         }, 1);
       }
     }
     savedSelActiveElement.addEventListener("input", 
       function() {
         saveSelection();
         while (b = savedSelActiveElement.querySelector('b')) 
                b.outerHTML = b.innerHTML;
         while (i = savedSelActiveElement.querySelector('i')) 
                i.outerHTML = i.innerHTML;
         while (br = savedSelActiveElement.querySelector('br')) 
                br.outerHTML = br.innerHTML;
         //prompt('',savedSelActiveElement.innerHTML);
         savedSelActiveElement.innerHTML = queryHighlighter(savedSelActiveElement.innerHTML);
         restoreSelection();
       }, false);

     var cellTypes = JSON.parse(<?= JSON.stringify(cellTypes) ?>);
     var evidence = JSON.parse(<?= JSON.stringify(evidence) ?>);

     function deleteTableRowsByID(ID) {
       var table = document.getElementById(ID).getElementsByTagName('table')[0];
       if (table) 
         if (table.rows.length > 1) 
           for(var i=1;i<table.rows.length;)
             table.deleteRow(i);
     } 

     function addTableRows(cKeys,connectionsObj,ID) {
       deleteTableRowsByID(ID)
       document.getElementById(ID).getElementsByTagName('b')[0].innerHTML = "Total: "+cKeys.length+":"
       var table = document.getElementById(ID).getElementsByTagName('table')[0];//alert(table);
       cKeys.forEach( 
         function(key){
           var eachCon = connectionsObj[key];
           var sUID = eachCon.source_id;
           var sCellName = ((sUID) ? cellTypes[sUID].Name : '');
           var dUID = eachCon.destination_id;
           var dCellName = ((dUID) ? cellTypes[dUID].Name : '');
           var rowArray = [sUID,sCellName,dUID,dCellName];
           table.insertRow().innerHTML = '<td>' + rowArray.join('</td><td>') + '</td>';
         });
     };

     function reCheckQuery(value) {
       var url = "http://hippocampome.org/csv2db/search_engine_json.php?query_str="+
         value.replace(/>/g,'%3E').replace(/</g,'%3C').replace(/\+/g,'%2B').replace(/\s+/g,' ');
       google.script.run.withSuccessHandler(function(response){
         var errorRegExp   = /<br>.*<br>/;
         var error         = (errorRegExp.test(response))? errorRegExp.exec(response)[0] : false;
         document.getElementById("error").innerHTML = '<b>Error:</b> ' + ((error)? error : 'No Error' );
         
         var fetchedConns  = JSON.parse(response.replace(errorRegExp,''));
         var connectionsMapped = evidence.PConnections.reduce(
         function(p,v,i){
           var [pre,post] = v.split(/\s*▶\s*/g)
           p[i]={source_id: pre.split(/:/g)[0], 
                 destination_id:post.split(/:/g)[0]}
           return p
         },{}) 

         var cKeys = Object.keys(fetchedConns);
         var cmKeys = Object.keys(connectionsMapped);
         var key = Object.keys(fetchedConns);

         addTableRows(cKeys,fetchedConns,"tableAll")

         addTableRows(cKeys.filter(
           function(ckey){
             var eachCon = fetchedConns[ckey]
             return !cmKeys.some(
               function(cmkey){
                 var cmCon = connectionsMapped[cmkey]
                 return (eachCon.source_id === cmCon.source_id && eachCon.destination_id === cmCon.destination_id)
               })
           }),fetchedConns,"tableSuggested")

        addTableRows(cmKeys.filter(
          function(cmkey) {
           var eachCon = connectionsMapped[cmkey]
           return !cKeys.some(
             function(key){
               var fCon = fetchedConns[key]
               return (fCon.source_id === eachCon.source_id && fCon.destination_id === eachCon.destination_id)
             })
          }),connectionsMapped,"tableDelete")
        }).accessApi(url);
      }
   </script>

   <? function showConnectionTable(cKeys,connectionsObj,title,bgColor,fontColor,ID) {?>
   <div id="<?=ID?>"><p><b>Total: <?=cKeys.length?>:</b> <?=title?></p>
   
   
   <table class='sortable'>
     <tr>
       <th style='background-color:<?=(bgColor)? bgColor:''?>;color:'<?=(fontColor)? fontColor:''?> > sUIDs </th>
       <th style='background-color:<?=(bgColor)? bgColor:''?>;color:'<?=(fontColor)? fontColor:''?> > Presynaptic Cell Types </th>
       <th style='background-color:<?=(bgColor)? bgColor:''?>;color:'<?=(fontColor)? fontColor:''?> > dUIDs </th>
       <th style='background-color:<?=(bgColor)? bgColor:''?>;color:'<?=(fontColor)? fontColor:''?> > Postsynaptic Cell Types </th>
     </tr>
     <? cKeys.forEach( 
          function(key){ 
            var eachCon = connectionsObj[key]  ?>
     <tr>
       <td>   <?= sUID = eachCon.source_id ?>           </td>
       <td>   <?= (sUID) ? cellTypes[sUID].Name : '' ?> </td>
       <td>   <?= dUID = eachCon.destination_id ?>      </td>
       <td>   <?= (dUID) ? cellTypes[dUID].Name : '' ?> </td>
     </tr>
     <?   });?>
     </table>
   </div><?
      }

      var cKeys = Object.keys(fetchedConns)  
      showConnectionTable(cKeys,fetchedConns,'Search engine results','green','white','tableAll')

      var connectionsMapped = evidence.PConnections.reduce(
        function(p,v,i){
          var [pre,post] = v.split(/\s*▶\s*/g)
          p[i]={source_id: pre.split(/:/g)[0], 
                destination_id:post.split(/:/g)[0]}
          return p
        },{})

      var cmKeys=Object.keys(connectionsMapped)

      showConnectionTable(cKeys.filter(
        function(ckey){
          var eachCon = fetchedConns[ckey]
          return !cmKeys.some(
            function(cmkey){
              var cmCon = connectionsMapped[cmkey]
              return (eachCon.source_id === cmCon.source_id && eachCon.destination_id === cmCon.destination_id)
            })
        }),fetchedConns,'Connections suggested by search engine to be added','blue','white','tableSuggested')

        var key = Object.keys(fetchedConns)

      showConnectionTable(cmKeys.filter(
        function(cmkey) {
          var eachCon = connectionsMapped[cmkey]
          return !cKeys.some(
            function(key){
              var fCon = fetchedConns[key]
              return (fCon.source_id === eachCon.source_id && fCon.destination_id === eachCon.destination_id)
            })
        }),connectionsMapped,'Connections suggested by search engine to be deleted','red','white','tableDelete')

   ?>
 </body>
</html>
