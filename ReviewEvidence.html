<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('script_CSS'); ?>
    <?//-----Functions----------------------------------------------------------------------------------------------------------------
        function showReferences(linkedRefIDs,allReferences,references,groupName,bgColor,fontColor,fontSize) {
          if (linkedRefIDs.length !== 0) { ?>
      <div class='eachReference'>    
      <details open>
        <summary style='background-color:<?=bgColor?>;color:<?=fontColor?>; margin:0; font-size:<?=fontSize?>;'>
          <?= groupName ?>
        </summary>
        <? linkedRefIDs.sort(function(a,b){return a-b}).forEach(function(refID){
            var theReference = references[refID]; ?>
        <details id='Reference' open>
          <summary style='background-color:black; color:white; margin:0; font-size:120%;'>
            <b>ID:</b><a style='color:pink' href='javascript:return false;' onclick="copyStringToClipboard(this.text)"><?= refID ?></a>, 
            <? if (typeof theReference !== "undefined") {
                 var UID = theReference.UID;?>
            <i style='color:yellow'><?=theReference.Location?></i>, 
            <?=  (isNumeric(UID)) ? ((cellTypes[UID]) ? cellTypes[UID].Name : '❌undefined cell type UID') : UID
               }?>
          </summary>
          <?if (typeof theReference === "undefined") {?>
          <p style='color:red;'>
            ❌ ID is not associated with any reference in our database. Delete it!
          </p>
          </details>
          <?} else {
              var UID = theReference.UID;
              if (UID) {?>
          <details>
            <summary style='background-color:#3F51B5; color:white; margin:0;'>
              <b>Cell Types:</b>
            </summary>
            <?  if (typeof UID === 'string') {
                  if (UID.replace(/[\s\d,;]+/g,'') !== '') {// is not a UID array in string format
                    UID.split(/\s*[,;]+\s*/g)
                       .filter(Null)
                       .forEach(function(eachUID){ ?>
            <p><?=       eachUID ?>
            </p><?     });
                  } else {
                    UID.split(/\s*[,;]+\s*/g)
                        .filter(Null)
                        .forEach(function(eachUID){?>
            <p><b><?=      eachUID ?>: </b><?=(cellTypes[eachUID]) ? cellTypes[eachUID].Name : '❌undefined cell type UID';?>
            </p>
            <?          }); 
                  };
                } else { ?>
            <p><b><?= UID ?>: </b><?= (cellTypes[UID]) ? cellTypes[UID].Name : UID+':❌undefined cell type UID'; ?>
            </p>
            <?  } ?>
          </details>
          <?  }?>
          <p>
            <?!= refHighlights(theReference.Quote) ?>
          </p>
          <?if (theReference.Figure) {
              String(theReference.Figure)
              .split(/\s*[;,]+\s*/g)
              .filter(Null)
              .forEach(function(fileName){
                var fileIDs = getFileIDs(fileName);
                if (fileIDs.length !== 0) {
                  fileIDs.forEach(function(fileID){
                    if (fileName.replace(/\.[^.]*$/g,'') === refID || (theReference.HcoRefID && imagesShown.indexOf(fileName) === -1)) {
                      imagesShown.push(fileName);?>
          <details open>
          <?        } else {?>
          <details>
          <?        }?>
            <summary style='background-color:#3F51B5; color:white; margin:0;'>
              <b>File: </b><a style='color:white' href='javascript:return false;' onclick="copyStringToClipboard(this.text)"><?=fileName?></a>
              <?    var possibleRefID = fileName.replace(/\.[^.]*$/g,'');
                    if (possibleRefID.replace(/\d*/g,'') === '') {
                      var theFigRef = allReferences[possibleRefID]; 
                      if (theFigRef) {?>
              <?=       theFigRef.Location?>
              <?      }};?>
            </summary>
            <img src='https://drive.google.com/uc?export=view&id=<?=fileID?>' style='width:100%;'>
            <?      if (theFigRef && (fileName.replace(/\.[^.]*$/g,'') !== refID)) {?>
            <p><?!=   (theFigRef.Location !== theReference.Location) ? refHighlights(theFigRef.Quote) : ''; ?>
              <?      theFigRef=null};?>
            </p>
          </details>
          <?      })} else {?>
          <p style='background-color:#3F51B5; color:white; margin:0;'>❌<b>File:</b> <?=String(fileName)?> does not exist</p>
          <?  }})};?>
        </details>
        <?}})?>
      </details>
      </div>
      <? }};
         
        function showAllReferences(presynapticRefIDs,postsynapticRefIDs,allReferences,groupReferences,groupName,bgColor,fontColor) {?>
      <details open>
        <summary style='background-color:<?=bgColor?>;color:<?=fontColor?>; margin:0; font-size:200%;'>
          <?=groupName?>
        </summary>
        <? var refIDsUniqueToPre  = presynapticRefIDs.filter(function(refID){return (postsynapticRefIDs.indexOf(refID) === -1)}); 
           var refIDsUniqueToPost = postsynapticRefIDs.filter(function(refID){return (presynapticRefIDs.indexOf(refID) === -1)}); 
           var refIDsCommonToBoth = presynapticRefIDs.filter(function(refID){return (refIDsUniqueToPre.indexOf(refID) === -1)});
           var linkedRefIds = mergeArrays(presynapticRefIDs,postsynapticRefIDs);
           var unlinkedRefIds = Object.keys(groupReferences).filter(function(refID){return (linkedRefIds.indexOf(refID) === -1)});
           showReferences(refIDsCommonToBoth,allReferences  ,allReferences,'✅Both Sides'       ,'#3F51B5','white','150%'); 
           showReferences(refIDsUniqueToPre ,allReferences  ,allReferences,'✅Presynaptic Only' ,'#3F51B5','white','150%'); 
           showReferences(refIDsUniqueToPost,allReferences  ,allReferences,'✅Postsynaptic Only','#3F51B5','white','150%'); 
           showReferences(unlinkedRefIds    ,allReferences,groupReferences,'❌Unlinked'         ,'#3F51B5','white','150%'); ?>
      </details>
      <?}; ?>
    <style>
      :root { 
        --googleFormWidth: 50vw;
      }
      .googleForm {
        float:left; 
        width: var(--googleFormWidth);
        height: 100vh;
      }
      .referencePanel {
        float:right; 
        overflow:auto;
        --referencePanelWidth: calc(100vw - var(--googleFormWidth));
        width: var(--referencePanelWidth);
        height: 100vh;
      }
      .toolBar {
        width:calc(var(--referencePanelWidth) - 15px);
        height:25px; 
        position:fixed; 
        background-color:black;
      }
      .eachReference {
        width:100%;
        word-wrap:normal;
      }
      
      p > br {
        line-height:200%;
      }
    </style>
  </head>
  <body>
<?//===========================================Top======================================================================================?>
    <iframe class='googleForm' src="<?=url?>" scrolling="yes" marginwidth="0" marginheight="0" frameborder="0" vspace="0" hspace="0"></iframe>
    <div id='main' class='referencePanel'>
      <div class='toolBar'>
         <input type='button' value='References:Collapse' onclick='toggleReferences(this);'>
         <input type='text' style='width:calc(100% - 150px);' placeholder='Case-sensitive Search and Highlight in Green' onchange="caseSensitiveSearch(this.value,'main');" >
      </div>
      <div id='evidence' style='margin-top:25px;'>
        <a href='https://www-ncbi-nlm-nih-gov.mutex.gmu.edu/pubmed/?term=<?=evidence.PMID?>' target='_blank'><?=covariates.Reference?></a><br>
        <?var unlinkedRefIds = Object.keys(myRefs).filter(function(refID){return (evidence.allRefIDs.indexOf(refID) === -1)});
          showAllReferences(evidence.CovariatesIDs      ,evidence.CovariatesIDs       ,allRefs,covariatesRef ,'Covariates:'                  ,'#99FFFF','black');
          showAllReferences(evidence.MorphologyIDsPre   ,evidence.MorphologyIDsPost   ,allRefs,morphology    ,'Anatomy & Morphology:'        ,'#F9DF16','black');
          showAllReferences(evidence.MarkersIDsPre      ,evidence.MarkersIDsPost      ,allRefs,markers       ,'Markers:'                     ,'#DD0083','yellow');
          showAllReferences(evidence.CellePhysIDsPre    ,evidence.CellePhysIDsPost    ,allRefs,cellEphys     ,'Electrophysiology:'           ,'#0090CC','yellow');
          showAllReferences(evidence.FiringPatternIDsPre,evidence.FiringPatternIDsPost,allRefs,firingPatterns,'Firing Patterns:'             ,'#F47C01','yellow');
          showAllReferences(evidence.ConnectivityIDsPre ,evidence.ConnectivityIDsPost ,allRefs,connectivity  ,'Connectivity:'                ,'#01AA59','yellow');
          showAllReferences(evidence.DataIDs            ,evidence.DataIDs             ,allRefs,dataRefs      ,'Synaptic Data:'               ,'#E91E63','white');
          showReferences   (unlinkedRefIds                                            ,allRefs,myRefs      ,'❌My Mixed Unlinked References:','#00F0F0','black','200%')?>
      </div>
    </div>
  </body>
</html>