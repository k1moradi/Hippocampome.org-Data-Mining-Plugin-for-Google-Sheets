<style>
@import url(https://fonts.googleapis.com/css?family=Open+Sans);
*, *::before, *::after {
  box-sizing: border-box;
}
input {
  //border: none;
  //outline: none;
  margin: 0;
  height: 24px;
  //width: 25px;
}
body {
  margin: 0px;
  background-color: #e8eaf6;
}
.container {
  display: block;
  margin: 0 auto;
  -webkit-transform: translateZ(0);
          transform: translateZ(0);
  -webkit-text-size-adjust: none;
}
.highlights {
  color: transparent;
  white-space: pre-wrap;
  word-wrap: break-word; //normal;
}
.backdrop {
  position: absolute;
  z-index: 1;
  border: 2px solid #685972;
  background-color: #fff;
  overflow: auto;
  pointer-events: none;
  -webkit-transition: -webkit-transform 1s;
  transition: -webkit-transform 1s;
  transition: transform 1s;
  transition: transform 1s, -webkit-transform 1s;
}
.textCleaner {
  display: block;
  position: absolute;
  z-index: 2;
  margin: 0;
  border: 2px solid #74637f;
  border-radius: 0;
  color: black;
  background-color: transparent;
  overflow: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
}
mark {
  border-radius: 3px;
  color: transparent;
  background-color: #b1d5e5;
  white-space: pre-wrap;
  word-wrap: break-word;
}
p {
  //text-indent: 1.5em;
  margin:0; 
  padding:0;
  word-wrap: break-word;
}
//p > i {
//  background-color:rgba(128,224,247,0.5);
//}
sup {
  font-size:50%;
  font-weight:bold;
  vertical-align:55%;
  //vertical-align: super;
}
sub {
  font-size:55%;
  font-weight:bold;
  vertical-align:0%;
  //vertical-align: sub;
}
table, tbody, thead, tfoot, tbody, tr, ol {
  width:calc(100vw-10px);
}
ol > li {
  width:calc(100vw-15px)
}
.button, .darkButton {
    background-color: #e8eaf6;
    border: none;//1px solid #4CAF50;
    color: black;
    padding: 0px 0px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    margin: 0px 0px;
    cursor: pointer;
    -webkit-transition-duration: 0.4s; /* Safari */
    transition-duration: 0.4s;
}
.button:hover {
    background-color: #555555;
    color: white;
}
.darkButton:hover {
    border: 1px solid paleturquoise;
    border-radius: 3px;
}
.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown-content {
    display: none;
    position: absolute;
    background-color: #e8eaf6;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
}

.dropdown-content a:hover {background-color: #f1f1f1}

.dropdown:hover .dropdown-content {
    display: block;
}

.dropdown:hover .dropbtn {
    background-color: #3e8e41;
}

#snackbar {
    visibility: hidden;
    min-width: 250px;
    margin-left: -125px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 2px;
    padding: 16px;
    position: fixed;
    z-index: 1;
    left: 50%;
    bottom: 30px;
    font-size: 17px;
}

#snackbar.show {
    visibility: visible;
    -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
    animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

@-webkit-keyframes fadein {
    from {bottom: 0; opacity: 0;} 
    to {bottom: 30px; opacity: 1;}
}

@keyframes fadein {
    from {bottom: 0; opacity: 0;}
    to {bottom: 30px; opacity: 1;}
}

@-webkit-keyframes fadeout {
    from {bottom: 30px; opacity: 1;} 
    to {bottom: 0; opacity: 0;}
}

@keyframes fadeout {
    from {bottom: 30px; opacity: 1;}
    to {bottom: 0; opacity: 0;}
}
</style>

<script language='JavaScript'>
  window.onload = function() {
    //document.getElementsByClassName('UID').forEach(
    Array.from(document.querySelectorAll('.disableClick')).forEach(
      function(elem){
        //disable click on focus to element
        elem.addEventListener('click',function(e) {
          e.preventDefault();
        });
        //disable click on keyup
        elem.addEventListener('keyup',function(e) {
          e.preventDefault();
        });
    });
  }
  
  function toggleReferences(button) {
    var detailSummaryElems = Array.from(document.querySelectorAll('.'+button.id))
    if (button.value === button.id+'.▶') {
      button.value =     button.id+'.▼';
      detailSummaryElems.forEach(function(obj) {obj.open = true});
    } else {
      button.value =     button.id+'.▶';
      detailSummaryElems.forEach(function(obj) {obj.open = false});
    }
  };//==========================================================================================================================
  function caseSensitiveSearch(text,id) {
    while (span = document.querySelector('.labnol')) 
      span.outerHTML = String(span.outerHTML).replace(/<span.*?class="labnol".*?>(.*?)<\/span>/g,"$1");
    if (text == null || text.length == 0) return;
    function searchWithinNode(node, te, len) {
      var pos, skip, spannode, middlebit, endbit, middleclone;
      skip = 0;
      if (node.nodeType == 3) {
        pos = node.data.indexOf(te);
        if (pos >= 0) {
          spannode = document.createElement('span');
          spannode.setAttribute('class', 'labnol');
          spannode.style.backgroundColor = 'rgb(140, 255, 26 )';
          middlebit = node.splitText(pos);
          endbit = middlebit.splitText(len);
          middleclone = middlebit.cloneNode(true);
          spannode.appendChild(middleclone);
          middlebit.parentNode.replaceChild(spannode, middlebit);
          skip = 1
        }
      } else if (node.nodeType == 1 && node.childNodes && node.tagName.toUpperCase() != 'SCRIPT' && node.tagName.toUpperCase != 'STYLE') {
        for (var child = 0; child < node.childNodes.length; ++child) {
          child = child + searchWithinNode(node.childNodes[child], te, len)
        }
      }
      return skip
    }
    text.split(/\s*\|+\s*|\s+/g
    ).filter(function(txt) {
      return txt
    }).sort(function(a, b) {
      return b.length - a.length
    }).forEach(function(txt) {
      searchWithinNode(document.getElementById(id), txt, txt.length)
    })
  };
  
  function copyStringToClipboard(string) {
    function handler(event){
        event.clipboardData.setData('text/plain', string);
        event.preventDefault();
        document.removeEventListener('copy', handler, true);
    }
    document.addEventListener('copy', handler, true);
    document.execCommand('copy');
  }
  function showSnackbar(htmlString){
    var x = document.getElementById("snackbar")
    x.innerHTML = htmlString;
    x.className = "show";
    setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000)
  }
  function saveReference(ref){
    var Error = false;
    try {
      var detailsSummaryElem = ref.parentElement.parentElement;
      var A1Notation = detailsSummaryElem.id;
      //var UIDelemValue = detailsSummaryElem.querySelector('.UID').innerText
      var UIDelemValue = detailsSummaryElem.querySelector('.UID').value
        .replace(/\s*(?:%3E|&gt;|>|▶)\s*/g,'▶')
        .replace(/\s*(?:%3C|&lt;|<|◀)\s*/g,'◀')
        .replace(/\s*(?:\*|❌)\s*/g,'❌')
        .replace(/\s+/g,' ');
    
      var Quote = detailsSummaryElem.querySelector('.Quote');
      //remove highlights
      while (mark = Quote.querySelector('mark')) 
        mark.outerHTML = mark.innerHTML;
      //remove case-sensitive search tool highlights
      while (span = Quote.querySelector('span')) 
        span.outerHTML = span.innerHTML;
      //convert <p> to <br>
      while (p = Quote.querySelector('p')) 
        p.outerHTML = p.innerHTML+'<br>';
    
      var quoteValue = Quote.innerHTML
        .replace(/(?:&nbsp;|[\s\r\n\x0A])+/g,' ')
        .replace(/^(?:<br>|&nbsp;|[\s\r\n\x0A])+|(?:<br>|&nbsp;|[\s\r\n\x0A])+$/g,'')
        .replace(/(?:(?:\s|<[bi]>)*<br>(?:\s|<[bi]>)*){2,}/g,'<br>')
        .replace(/&lt;/g,'<')
        .replace(/&gt;/g,'>')
        .replace(/&ndash;/g,'—')
        .replace(/&amp;/g,'&');
      
      var quoteValueHighlighted = refHighlights(quoteValue);
      
      Error = Array.from(document.querySelectorAll('.Refs')).filter(
        function(element) {
          //alert(element.id+' : '+A1Notation)
          if (element.id === A1Notation) {
            //element.querySelector('.UID').innerText = UIDelemValue;
            element.querySelector('.UID').value = UIDelemValue;
            element.querySelector('.Quote').innerHTML = '<p>'+quoteValueHighlighted+'</p>';
            return true; //means no error
          } else {
            return false;
          }
        }).length === 0;
    } catch(error) {
      Error = true;
    }
    
    if (!Error) {google.script.run
      .withFailureHandler(showSnackbar("<b style='color:lightsalmon'>failed to save</b>"))
      .withSuccessHandler(showSnackbar('saved successfully'))
      .saveReferenceToSheet(A1Notation,UIDelemValue.replace(/^\s*[,;]+\s*|\s*[,;]+\s*$/g,''),quoteValue);
    } else {
      showSnackbar("<b style='color:lightgoldenrodyellow'>failed to save</b>");
    }
  }
</script>
<div id="snackbar"></div>